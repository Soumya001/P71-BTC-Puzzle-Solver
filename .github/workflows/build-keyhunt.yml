name: Build KeyHunt-Cuda Windows

on:
  workflow_dispatch:

jobs:
  build-keyhunt-windows:
    runs-on: windows-2019
    steps:
      - name: Checkout KeyHunt-Cuda source
        uses: actions/checkout@v4
        with:
          repository: manyunya/KeyHunt-Cuda
          path: keyhunt

      - name: Install CUDA Toolkit 12.4
        uses: Jimver/cuda-toolkit@v0.2.19
        id: cuda-toolkit
        with:
          cuda: '12.4.0'
          method: 'network'

      - name: Setup MSVC
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: Build KeyHunt-Cuda
        shell: cmd
        run: |
          cd keyhunt\KeyHunt-Cuda

          set CUDA_PATH=%CUDA_PATH%
          set GMP_INC=..\gmp\include
          set GMP_LIB=..\gmp\lib\x64

          mkdir obj
          mkdir obj\GPU
          mkdir obj\hash

          set CL_FLAGS=/c /O2 /EHsc /MD /DWIN32 /DWIN64 /DNDEBUG /D_CONSOLE /DWITHGPU /D_CRT_SECURE_NO_WARNINGS /I. /I"%CUDA_PATH%\include" /I%GMP_INC%

          echo === Compiling C++ sources ===
          for %%f in (Base58.cpp Bloom.cpp CmdParse.cpp GmpUtil.cpp IntGroup.cpp Int.cpp IntMod.cpp KeyHunt.cpp Main.cpp Point.cpp Random.cpp SECP256K1.cpp Timer.cpp) do (
            echo Compiling %%f...
            cl %CL_FLAGS% /Fo"obj\%%~nf.obj" %%f
            if errorlevel 1 exit /b 1
          )

          echo === Compiling GPU source files ===
          cl %CL_FLAGS% /Fo"obj\GPUGenerate.obj" GPU\GPUGenerate.cpp
          if errorlevel 1 exit /b 1

          echo === Compiling hash sources ===
          for %%f in (hash\ripemd160.cpp hash\ripemd160_sse.cpp hash\sha256.cpp hash\sha256_sse.cpp hash\sha512.cpp hash\keccak160.cpp) do (
            echo Compiling %%f...
            cl %CL_FLAGS% /Fo"obj\%%~nf.obj" %%f
            if errorlevel 1 exit /b 1
          )

          echo === Compiling CUDA kernel ===
          nvcc --compile -O2 -m64 -DWITHGPU -DWIN32 -DWIN64 -D_CRT_SECURE_NO_WARNINGS -I. -I"%CUDA_PATH%\include" -I%GMP_INC% -gencode=arch=compute_50,code=sm_50 -gencode=arch=compute_52,code=sm_52 -gencode=arch=compute_60,code=sm_60 -gencode=arch=compute_61,code=sm_61 -gencode=arch=compute_70,code=sm_70 -gencode=arch=compute_75,code=sm_75 -gencode=arch=compute_80,code=sm_80 -gencode=arch=compute_86,code=sm_86 -gencode=arch=compute_89,code=sm_89 "-gencode=arch=compute_90,code=sm_90" -o obj\GPU\GPUEngine.obj -c GPU\GPUEngine.cu
          if errorlevel 1 exit /b 1

          echo === Linking ===
          link /OUT:KeyHunt.exe /MACHINE:X64 /SUBSYSTEM:CONSOLE obj\Base58.obj obj\Bloom.obj obj\CmdParse.obj obj\GmpUtil.obj obj\GPUGenerate.obj obj\IntGroup.obj obj\Int.obj obj\IntMod.obj obj\KeyHunt.obj obj\Main.obj obj\Point.obj obj\Random.obj obj\SECP256K1.obj obj\Timer.obj obj\ripemd160.obj obj\ripemd160_sse.obj obj\sha256.obj obj\sha256_sse.obj obj\sha512.obj obj\keccak160.obj obj\GPU\GPUEngine.obj %GMP_LIB%\gmp.lib cudart_static.lib kernel32.lib user32.lib advapi32.lib /LIBPATH:"%CUDA_PATH%\lib\x64"
          if errorlevel 1 exit /b 1

          echo === Build complete ===
          dir KeyHunt.exe

      - name: Upload KeyHunt.exe
        uses: actions/upload-artifact@v4
        with:
          name: keyhunt-windows
          path: keyhunt/KeyHunt-Cuda/KeyHunt.exe
